<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2015-02-17T14:42:36.342765+02:00</xqdoc:date><xqdoc:version>1.0</xqdoc:version></xqdoc:control><xqdoc:module type="library"><xqdoc:uri>http://www.28msec.com/modules/trademarks/updates</xqdoc:uri><xqdoc:name>updates</xqdoc:name><xqdoc:comment><xqdoc:description> This module contains functions allowing to react to trademark updates.
</xqdoc:description><xqdoc:author>Alexander.Kreutz@28msec.com <h2>Usage example</h2> <p>Example code snippet:</p> <pre> variable $updates := updates:request-updates("myservice", 10000, false()); try { if (exists($updates)) then { for $trademark in updates:trademarks($updates) return { ... // do something with the updated trademark } updates:confirm-updates($updates); } else () // Nothing to process } catch * { updates:mark-failed($updates); fn:error($err:code, $err:description, $err:value) } </pre> <p>This example code</p> <ul> <li>Requests a maximum of 10000 trademarks that have not yet been processed by this code snippet.</li> <li>It iterates over all updated trademarks and may do any action with each trademark. (for example generate some content)</li> <li>Afterwards it confirms the update so it gets newer updates the next time it is run.</li> <li>If an error occurs it marks the update as failed so it retrieves the same set of trademarks the next time it is run.</li> </ul></xqdoc:author><xqdoc:custom tag="language">jsoniq</xqdoc:custom><xqdoc:custom tag="version">1.0</xqdoc:custom><xqdoc:custom tag="encoding">utf-8</xqdoc:custom></xqdoc:comment><xqdoc:custom tag="namespaces"><xqdoc:namespace prefix="an" uri="" isSchema="false"/><xqdoc:namespace prefix="mongo" uri="http://www.28msec.com/modules/mongodb" isSchema="false"/><xqdoc:namespace prefix="trademarks" uri="http://www.28msec.com/modules/trademarks" isSchema="false"/><xqdoc:namespace prefix="updates" uri="http://www.28msec.com/modules/trademarks/updates" isSchema="false"/></xqdoc:custom></xqdoc:module><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>http://www.28msec.com/modules/trademarks</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:variables><xqdoc:variable><xqdoc:uri>updates:statuscollection</xqdoc:uri><xqdoc:annotations><xqdoc:annotation prefix="" namespace="http://www.w3.org/2005/xpath-functions" localname="private" value=""/></xqdoc:annotations></xqdoc:variable><xqdoc:variable><xqdoc:uri>updates:timeout</xqdoc:uri><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2001/XMLSchema</xqdoc:uri><xqdoc:name>dayTimeDuration</xqdoc:name></xqdoc:invoked><xqdoc:annotations><xqdoc:annotation prefix="" namespace="http://www.w3.org/2005/xpath-functions" localname="private" value=""/></xqdoc:annotations></xqdoc:variable></xqdoc:variables><xqdoc:collections/><xqdoc:indexes/><xqdoc:functions><xqdoc:function arity="0"><xqdoc:name>updates:max-update-id</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="" namespace="http://www.w3.org/2005/xpath-functions" localname="private" value=""/></xqdoc:annotations><xqdoc:signature>declare %private function updates:max-update-id() as integer</xqdoc:signature><xqdoc:return><xqdoc:type>integer</xqdoc:type></xqdoc:return><xqdoc:invoked arity="2"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="3"><xqdoc:comment><xqdoc:description> Request a chunk of unprocessed trademark updates.
</xqdoc:description><xqdoc:param>$service-name a project unique name for what you want to do with the updates. (like generate-sitemap)</xqdoc:param><xqdoc:param>$limit the maximum number of trademark updates you want to process now.</xqdoc:param><xqdoc:param>$allow-parallelization set to true if what you want to do with the updates may be done in parralel using multiple instances. Using false will block later calls to request-updates for the given service-name until the returned updates have been confirmed or marked as failed.</xqdoc:param><xqdoc:return>an update status object that may be passed to the other functions of this library</xqdoc:return></xqdoc:comment><xqdoc:name>updates:request-updates</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="an" namespace="" localname="sequential" value=""/></xqdoc:annotations><xqdoc:signature>declare %an:sequential function updates:request-updates($service-name as string, $limit as integer, $allow-parallelization as boolean) as object()?</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>service-name</xqdoc:name><xqdoc:type>string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>limit</xqdoc:name><xqdoc:type>integer</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>allow-parallelization</xqdoc:name><xqdoc:type>boolean</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="?">object()?</xqdoc:type></xqdoc:return><xqdoc:invoked arity="0"><xqdoc:uri>http://www.28msec.com/modules/trademarks/updates</xqdoc:uri><xqdoc:name>max-update-id</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2001/XMLSchema</xqdoc:uri><xqdoc:name>QName</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>current-dateTime</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="2"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>error</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>exists</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="2"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>flush</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="2"><xqdoc:uri>http://zorba.io/modules/store/static/collections/dml</xqdoc:uri><xqdoc:name>apply-insert</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Confirm that a chunk of trademark updates have been successfully processed.
</xqdoc:description><xqdoc:param>$update-obj an update status object obtained using the request-updates function.</xqdoc:param><xqdoc:return>empty-sequence()</xqdoc:return></xqdoc:comment><xqdoc:name>updates:confirm-updates</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="an" namespace="" localname="sequential" value=""/></xqdoc:annotations><xqdoc:signature>declare %an:sequential function updates:confirm-updates($update-obj as object()) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>update-obj</xqdoc:name><xqdoc:type>object()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>http://www.28msec.com/modules/trademarks/updates</xqdoc:uri><xqdoc:name>merge</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>flush</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Mark a trademark update chunk as failed so the updates may be requested again.
</xqdoc:description><xqdoc:param>$update-obj an update status object obtained using the request-updates function.</xqdoc:param><xqdoc:return>empty-sequence()</xqdoc:return></xqdoc:comment><xqdoc:name>updates:mark-failed</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="an" namespace="" localname="sequential" value=""/></xqdoc:annotations><xqdoc:signature>declare %an:sequential function updates:mark-failed($update-obj as object()) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>update-obj</xqdoc:name><xqdoc:type>object()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>flush</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Reset trademark updates for a service name so that all updates may be processed again by this service.
</xqdoc:description><xqdoc:param>$service-name a project unique name used with the request-updates function. After reset-to-beginning has been called request-updates will return all updates again for this service-name.</xqdoc:param><xqdoc:return>empty-sequence()</xqdoc:return></xqdoc:comment><xqdoc:name>updates:reset-to-beginning</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="an" namespace="" localname="sequential" value=""/></xqdoc:annotations><xqdoc:signature>declare %an:sequential function updates:reset-to-beginning($service-name as string) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>service-name</xqdoc:name><xqdoc:type>string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="2"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>flush</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://zorba.io/modules/store/static/collections/dml</xqdoc:uri><xqdoc:name>delete</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:name>updates:merge</xqdoc:name><xqdoc:annotations><xqdoc:annotation prefix="" namespace="http://www.w3.org/2005/xpath-functions" localname="private" value=""/><xqdoc:annotation prefix="an" namespace="" localname="sequential" value=""/></xqdoc:annotations><xqdoc:signature>declare %private %an:sequential function updates:merge($service-name as string) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>service-name</xqdoc:name><xqdoc:type>string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="2"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>flush</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://zorba.io/modules/store/static/collections/dml</xqdoc:uri><xqdoc:name>delete</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Return trademarks contained in an trademark update chunk.
</xqdoc:description><xqdoc:param>$updates an update status object obtained from request-updates()</xqdoc:param><xqdoc:return>a sequence of trademarks that have been updated</xqdoc:return></xqdoc:comment><xqdoc:name>updates:trademarks</xqdoc:name><xqdoc:signature>declare function updates:trademarks($updates as object()) as object()*</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>updates</xqdoc:name><xqdoc:type>object()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="*">object()*</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Return only trademarks contained in an trademark update chunk that have been added freshly to the database during that update.
</xqdoc:description><xqdoc:param>$updates an update status object obtained from request-updates()</xqdoc:param><xqdoc:return>a sequence of trademarks that have been added to the database during the requested updates</xqdoc:return></xqdoc:comment><xqdoc:name>updates:added-trademarks</xqdoc:name><xqdoc:signature>declare function updates:added-trademarks($updates as object()) as object()*</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>updates</xqdoc:name><xqdoc:type>object()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="*">object()*</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Return only trademarks contained in an trademark update chunk that have been renamed during that update.
</xqdoc:description><xqdoc:param>$updates an update status object obtained from request-updates()</xqdoc:param><xqdoc:return>a sequence of trademarks that have been renamed with an additional key "old-mark-identification" with the old trademark name as value.</xqdoc:return></xqdoc:comment><xqdoc:name>updates:renamed-trademarks</xqdoc:name><xqdoc:signature>declare function updates:renamed-trademarks($updates as object()) as object()*</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>updates</xqdoc:name><xqdoc:type>object()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="*">object()*</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description> Return the trademark for a given update number
</xqdoc:description><xqdoc:param>$update-id the update number of the trademark update</xqdoc:param><xqdoc:return>the trademark having that update number or empty sequence</xqdoc:return></xqdoc:comment><xqdoc:name>updates:get-trademark-by-update-id</xqdoc:name><xqdoc:signature>declare function updates:get-trademark-by-update-id($update-id as integer) as object()?</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>update-id</xqdoc:name><xqdoc:type>integer</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="?">object()?</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://www.28msec.com/modules/mongodb</xqdoc:uri><xqdoc:name>find</xqdoc:name></xqdoc:invoked></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>